
теперь попробуем сделать кое-что поинтереснее: сгруппируем наши данные не по имеющейся в таблице колонке, а по расчётной.

Чтобы понять, как это работает, просто представьте, что сначала вы создаёте какую-то новую колонку на основе уже имеющейся, применяя к ней какую-то функцию, а потом сразу в этом же запросе производите группировку по новой колонке.

SELECT UPPER(column_1) AS upper_column, SUM(column_2) AS sum
FROM table
GROUP BY UPPER(column_1)

давайте посчитаем, сколько заказов было сделано в каждом месяце. Разумеется, для этого нам потребуется как-то получить месяц из каждой даты. Это можно было бы сделать с помощью функции `DATE_PART`, но в этот раз для работы с датами мы попробуем новую функцию `DATE_TRUNC`.

Функция `DATE_TRUNC` используется для усечения дат и времени, т.е. она работает аналогично округлению `ROUND`, только для типов данных `TIMESTAMP` и `INTERVAL`.

Синтаксис у неё такой же, как и у `DATE_PART`:

SELECT DATE_TRUNC(part, column)

SELECT DATE_TRUNC('month', TIMESTAMP '2022-01-12 08:55:30')

Результат:
01/01/22 00:00

SELECT DATE_TRUNC('day', TIMESTAMP '2022-01-12 08:55:30')

Результат:
12/01/22 00:00	

SELECT DATE_TRUNC('hour', TIMESTAMP '2022-01-12 08:55:30')

Результат:
12/01/22 08:00

## **Задание:**

Используя группировку и функцию `DATE_TRUNC`, приведите все даты к началу месяца и посчитайте, сколько заказов было сделано в каждом из них.

Расчёты проведите по таблице `orders`. Колонку с усечённой датой назовите `month`, колонку с количеством заказов — `orders_count`.

Результат отсортируйте по месяцам — по возрастанию.

Поля в результирующей таблице: `month`, `orders_count`


SELECT date_trunc('month', creation_time) as month,
       count(order_id) as orders_count
FROM   orders
GROUP BY date_trunc('month', creation_time)
ORDER BY month

# А теперь немного усложним нашу группировку: добавим в неё вторую колонку и посчитаем, сколько заказов было сделано и сколько было отменено в каждом месяце.

---

## **Задание:**

Используя группировку и функцию `DATE_TRUNC`, приведите все даты к началу месяца и посчитайте, сколько заказов было сделано и сколько было отменено в каждом из них.

В этот раз расчёты проведите по таблице `user_actions`. Колонку с усечённой датой назовите `month`, колонку с количеством заказов — `orders_count`.

Результат отсортируйте сначала по месяцам — по возрастанию, затем по типу действия — тоже по возрастанию.

Поля в результирующей таблице: `month`, `action`, `orders_count`

---

**Пояснение:**

В результате группировки по двум полям для каждого месяца у вас должно появиться ещё по две подгруппы с типом действия (создание заказа и отмена). В каждой такой подгруппе необходимо посчитать число заказов.


SELECT date_trunc('month', time) as month,
       action,
       count(order_id) as orders_count
FROM   user_actions
GROUP BY month, action
ORDER BY month, action

[[Группировка_данных_content]]

