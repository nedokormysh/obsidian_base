Расчётные колонки можно использовать не только для того, чтобы группировать по ним данные. Их можно также использовать в качестве полей, по которым производится агрегация внутри групп.

Иными словами, агрегацию не обязательно проводить по уже имеющимся колонкам — колонки можно «создавать» в рамках того же запроса, в котором происходит группировка:

SELECT column_1, MIN(DATE_TRUNC('month', column_2)) AS min_month
FROM table
GROUP BY column_1

SELECT column_1, DATE_TRUNC('month', MIN(column_2)) AS min_month
FROM table
GROUP BY column_1

Получается, что и к результату агрегирующей функции можно сразу же применять другие функции.

При этом в примерах выше не имеет значения, в каком порядке проводить вычисления: мы можем сначала округлить даты, а затем найти среди них минимальную, или же сначала найти минимальную дату и затем округлить её.

Но нужно быть внимательными: часто результат зависит от того, в каком порядке применяются обычные и агрегирующие функции. Например, следующие два запроса дадут разный результат:

SELECT column_1, MIN(DATE_PART('month', column_2)) AS min_month
FROM table
GROUP BY column_1


SELECT column_1, DATE_PART('month', MIN(column_2)) AS min_month
FROM table
GROUP BY column_1

В первом запросе из каждой даты в колонке column_2 мы сначала выделяем все порядковые номера месяцев, а затем в каждой группе находим среди них минимальный. В то же время во втором запросе сначала определяется минимальная дата в каждой группе, а потом вычисляется порядковый номер месяца в этой дате.

Разумеется, результат может отличаться, поскольку в данных могут быть даты за разные годы — в самом раннем году могут не оказаться даты с некоторыми месяцами, тогда как в более поздних годах даты с этими месяцами будут. Из-за этого и возможна ситуация, когда запросы будут давать разный результат.

Давайте рассмотрим подобные случаи на практике.

---

## **Задание:**

По данным в таблице `users` посчитайте максимальный порядковый номер месяца среди всех порядковых номеров месяцев рождения пользователей сервиса. С помощью группировки проведите расчёты отдельно в двух группах — для пользователей мужского и женского пола.

Новую колонку с максимальным порядковым номером месяца рождения в группах назовите `max_month`. Преобразуйте значения в новой колонке в формат `INTEGER`, чтобы порядковый номер был выражен целым числом.

Результат отсортируйте по колонке с полом пользователей.

Поля в результирующей таблице: `sex`, `max_month`

[[Группировка_данных_content]]