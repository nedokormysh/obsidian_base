
Итак, на лекции мы познакомились с подзапросами (вложенными запросами) и поняли, что в целом их синтаксис ничем не отличается от синтаксиса обычных запросов, которые мы составляли ранее. Иными словами, подзапрос — это всего лишь запрос внутри другого запроса.

Подзапросы могут применяться в следующих частях основного запроса:

- в операторе `FROM`;
- в операторе `SELECT` (если запрос возвращает один столбец с одним значением);
- в операторах `WHERE` и `HAVING` (если запрос возвращает один столбец с одним или несколькими значениями);
- в операторе `CASE` при формировании продвинутых условных конструкций.

---

Но давайте обо всём по порядку.

Прежде всего важно понять, что к результату выполнения подзапроса можно обращаться так же, как и к таблицам в базе данных, т.е. использовать их в блоке `FROM` вместо имеющихся таблиц:

SELECT column_1
FROM (
    SELECT column_1, column_2
    FROM table
) AS subquery_1

По сути подзапрос — это такая же таблица, только временная. Она формируется в процессе выполнения основного запроса и нигде не сохраняется.

В примере выше сначала будет выполнен подзапрос, который отберёт колонки `column_1` и `column_2` из таблицы `table`, а затем уже из образовавшейся таблицы основной запрос выберет колонку `column_1`.

Важный момент: при использовании подзапроса в блоке `FROM` сформированной в подзапросе таблице необходимо присвоить какой-нибудь алиас, иначе основной запрос не сработает. В примере выше мы обозначили результат подзапроса как `subquery_1`.

Приведённый пример довольно условный и на практике колонки таким образом отбирать не стоит, но общую идею он должен передавать.

Давайте рассмотрим ещё один пример. Он тоже довольно условный, но должен помочь нам во всём разобраться. Мы уже знаем, что посчитать число пользователей мужского пола можно двумя способами:

SELECT sex, COUNT(user_id) AS users_count
FROM users
WHERE sex = 'male'
GROUP BY sex


SELECT sex, COUNT(user_id) AS users_count
FROM users
GROUP BY sex
HAVING sex = 'male'

Но то же самое можно сделать и с помощью подзапроса:

SELECT sex, users_count
FROM (
    SELECT sex, COUNT(user_id) AS users_count
    FROM users
    GROUP BY sex
) AS subquery
WHERE sex = 'male'

Что же здесь произошло? Всё довольно просто: в подзапросе мы сначала сгруппировали наши данные по полу и посчитали число пользователей в каждой группе, а потом обратились к результату этого подзапроса, как к таблице, и отобрали с помощью `WHERE` нужную нам группу.

---

Внутри одного запроса может быть сразу несколько подзапросов. Более того, уровней вложенности может быть тоже несколько:

SELECT column_1
FROM (
    SELECT column_1, column_2
    FROM (
        SELECT column_1, column_2, column_3
        FROM table
    ) AS subquery_1
) AS subquery_2

В данном случае последовательность работы запроса такая: сначала будет выполнен подзапрос, возвращающий результат `subquery_1`, затем подзапрос, возвращающий результат `subquery_2`, и только потом в результат основного подзапроса попадёт колонка `column_1`. В результате получается что-то похожее на матрёшку, при этом к основной таблице `table` обращается только самый первый подзапрос `subquery_1`.

К колонкам из подзапроса можно применять агрегирующие функции — так же, как если бы мы обращались к колонкам исходных таблиц:

SELECT MAX(column_sum) AS max_sum
FROM (
    SELECT column_1, SUM(column_2) AS column_sum
    FROM table
    GROUP BY column_1
) AS subquery_1

Здесь сначала в подзапросе мы сгруппируем данные по колонке column_1, посчитав для каждой группы сумму значений в колонке column_2, а затем уже в основном запросе найдём максимальное значение среди всех сумм.

На самом деле вариантов того, как можно использовать подзапросы, очень много. Это крайне полезный функционал, который позволяет формировать продвинутые запросы со сложной логикой. Кроме того, понимание, как работают подзапросы в блоке `FROM`, нам особенно пригодится, когда в следующем уроке мы будем учиться объединять таблицы с помощью оператора `JOIN`.

## **Задание:**

Используя данные из таблицы `user_actions`, рассчитайте среднее число заказов всех пользователей нашего сервиса.

Для этого сначала в подзапросе посчитайте, сколько заказов сделал каждый пользователь, а затем обратитесь к результату подзапроса в блоке `FROM` и уже в основном запросе усредните количество заказов по всем пользователям.

Полученное среднее число заказов всех пользователей округлите до двух знаков после запятой. Колонку с этим значением назовите `orders_avg`.

Поле в результирующей таблице: `orders_avg`
