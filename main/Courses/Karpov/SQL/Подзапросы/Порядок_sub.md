
К текущему уроку мы уже успели познакомиться с основными операторами, которые составляют «скелет» стандартного SQL-запроса: `SELECT`, `FROM`, `WHERE`, `GROUP BY`, `HAVING`, `ORDER BY` и `LIMIT`.

Мы уже знаем, что порядок их указания в запросе следующий
SELECT     -- перечисление полей результирующей таблицы
FROM       -- указание источника данных
WHERE      -- фильтрация данных
GROUP BY   -- группировка данных
HAVING     -- фильтрация данных после группировки
ORDER BY   -- сортировка результирующей таблицы
LIMIT      -- ограничение количества выводимых записей

Тем не менее важно помнить, что порядок выполнения операторов в СУБД несколько отличается от порядка их написания в запросе. В упрощённом виде порядок выполнения запроса в PostgreSQL такой:

FROM       -- указание источника данных
WHERE      -- фильтрация данных
GROUP BY   -- группировка данных
HAVING     -- фильтрация данных после группировки
SELECT     -- перечисление полей результирующей таблицы
ORDER BY   -- сортировка результирующей таблицы
LIMIT      -- ограничение количества выводимых записей

Таким образом:

1. Сначала с помощью `FROM` определяется таблица.
2. Затем в соответствии с указанным в `WHERE` условием из этой таблицы отбираются записи.
3. Потом выбранные данные группируются и агрегируются с помощью `GROUP BY`.
4. Далее из агрегированных записей отбираются те, которые удовлетворяют условию в `HAVING`.
5. Только после этого в соответствии с указанными в `SELECT` инструкциями формируется результирующая таблица — отбираются нужные колонки, расчётным полям присваиваются новые имена и т.д.
6. Затем результирующая таблица сортируется в соответствии с правилами в `ORDER BY`.
7. И наконец срабатывает ограничение на количество строк, указанное в `LIMIT`.

И ещё один важный совет. Обратите внимание: фильтрацию данных по неагрегированным значениям можно делать как в блоке `WHERE`, так и в блоке `HAVING`. Внимательно посмотрите на следующие запросы:

SELECT sex, COUNT(user_id) AS users_count
FROM users
WHERE sex = 'male'
GROUP BY sex


SELECT sex, COUNT(user_id) AS users_count
FROM users
GROUP BY sex
HAVING sex = 'male'

Их результат будет одинаковым — можете убедиться в этом сами.

Однако фильтровать неагрегированные данные рекомендуется именно в блоке `WHERE`, т.е. заранее. В таком случае вы ещё до группировки убираете из расчётов ненужные вам данные и таким образом не расходуете вычислительные ресурсы на подсчёт значений, которые всё равно будут отфильтрованы вами позже (например, с помощью `HAVING`).

Это важный момент, касающийся оптимизации SQL-запросов, поэтому рекомендуем вам принять во внимание информацию, представленную на этом шаге.