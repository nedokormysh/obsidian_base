Мы рассмотрели несколько примеров, когда в качестве аргумента агрегирующих функций выступает результат выполнения другой функции.

Но агрегирующая функция может и сама оказаться на месте аргумента какой-то функции:

SELECT ROUND(SUM(column)) AS rounded_sum
FROM table

## **Задание:**

Рассчитайте среднюю цену товаров в таблице `products`, в названиях которых присутствуют слова «чай» или «кофе». Любым известным способом исключите из расчёта товары, содержащие в названии «иван-чай» или «чайный гриб».

Среднюю цену округлите до двух знаков после запятой. Столбец с полученным значением назовите `avg_price`.

Поле в результирующей таблице: `avg_price`

SELECT round(avg(price), 2) as avg_price
FROM   products
WHERE  (name ilike '%чай%'
    or name ilike '%кофе%')
   and name not ilike '%иван-чай%'
   and name not ilike '%чайный гриб%'


# Впрочем, бывают и случаи, когда в качестве аргументов некоторой функции выступают сразу несколько агрегирующих функций:

SELECT some_function(SUM(column_1), SUM(column_2)) AS result
FROM table

Например, нам уже знакома функция `AGE`, которая может принимать сразу два аргумента — дату конца и дату начала некоторого периода времени.

---

## **Задание:**

Воспользуйтесь функцией `AGE` и рассчитайте разницу в возрасте между самым старым и самым молодым пользователями мужского пола в таблице `users`. 

Разницу в возрасте выразите количеством лет, месяцев и дней, переведя её в тип `VARCHAR`. 

Колонку с посчитанным значением назовите `age_diff`.

Поле в результирующей таблице: `age_diff`

SELECT age(max(birth_date), min(birth_date))::varchar as age_diff
FROM   users
WHERE  sex = 'male'

# А теперь рассмотрим пример, когда агрегирующая функция принимает в качестве аргумента одну функцию и при этом сама является аргументом другой функции.

Выглядеть это может так:

SELECT function_two(SUM(funtion_one(column))) AS result
FROM table

В этом примере сначала к колонке column применится функция `function_one`, затем с помощью функции `SUM` будет посчитана сумма полученных значений, и только потом к результату агрегации применится функция `function_two`.

---

## **Задание:**

Рассчитайте среднее количество товаров в заказах из таблицы `orders`, которые пользователи оформляли по выходным дням (суббота и воскресенье) в течение всего времени работы сервиса.

Полученное значение округлите до двух знаков после запятой. Колонку с ним назовите `avg_order_size`.

Поле в результирующей таблице: `avg_order_size`

SELECT round(avg(array_length(product_ids, 1)), 2) as avg_order_size
FROM   orders
WHERE  date_part('dow', creation_time) in (0, 6)

[[Аггрегация_данных_content]]


